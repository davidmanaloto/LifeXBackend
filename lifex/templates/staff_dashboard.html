<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Portal - LifeX Medical Records</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4F46E5;
            --primary-light: #EEF2FF;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --dark: #1F2937;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-600: #4B5563;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-50);
            color: var(--dark);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-items {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--gray-600);
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--gray-100);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
        }

        .user-card {
            margin-top: auto;
            padding-top: 24px;
            border-top: 1px solid var(--gray-200);
        }

        .user-info-mini {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .logout-btn {
            color: var(--danger);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
        }

        /* Main Content */
        main {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: var(--gray-50);
            position: relative;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-title h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .page-title p {
            color: var(--gray-600);
        }

        /* Cards & UI Elements */
        .card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
        }

        .stat-card .label {
            color: var(--gray-600);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .full-width {
            grid-column: span 2;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            transition: 0.2s;
            font-family: 'Inter', sans-serif;
        }

        input:focus,
        select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #4338CA;
        }

        .btn-outline {
            background: white;
            border: 1px solid var(--gray-200);
            color: var(--gray-600);
        }

        .btn-outline:hover {
            background: var(--gray-100);
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        th {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-200);
            color: var(--gray-600);
            font-weight: 600;
            font-size: 13px;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--gray-100);
            font-size: 14px;
        }

        tr:hover td {
            background-color: var(--gray-50);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 99px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-active {
            background: #D1FAE5;
            color: #065F46;
        }

        /* Notification Panel */
        .notifications-panel {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 360px;
            background: white;
            border-left: 1px solid var(--gray-200);
            transform: translateX(100%);
            transition: 0.3s;
            z-index: 100;
            padding: 24px;
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.05);
        }

        .notifications-panel.active {
            transform: translateX(0);
        }

        .notification-item {
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--gray-100);
            margin-bottom: 12px;
            font-size: 13px;
            position: relative;
        }

        .notification-item.unread {
            border-left: 4px solid var(--primary);
            background: var(--primary-light);
        }

        .notification-item .time {
            font-size: 11px;
            color: var(--gray-600);
            margin-top: 4px;
        }

        /* Loading & Empty States */
        .loading-pulse {
            animation: pulse 1.5s infinite;
            color: var(--gray-600);
            text-align: center;
            padding: 40px;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* UI Helpers */
        .hidden {
            display: none !important;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Calendar Styles */
        .calendar-wrapper {
            margin-top: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--gray-200);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: var(--gray-50);
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            color: var(--gray-600);
        }

        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 10px;
            position: relative;
        }

        .calendar-day.today {
            background: var(--primary-light);
        }

        .calendar-day.other-month {
            background: var(--gray-50);
            color: var(--gray-200);
        }

        .day-number {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            display: inline-block;
        }

        .event-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .calendar-event {
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-event.CHECKED_IN {
            background: var(--secondary);
        }

        .calendar-event.COMPLETED {
            background: var(--gray-600);
            opacity: 0.7;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="24" height="24" rx="6" fill="#4F46E5" />
                    <path d="M12 7V17M7 12H17" stroke="white" stroke-width="2.5" stroke-linecap="round" />
                </svg>
                LifeX
            </div>

            <nav class="nav-items" id="navItems">
                <!-- Items injected by JavaScript based on role -->
            </nav>

            <div class="user-card">
                <div class="user-info-mini">
                    <div class="user-avatar" id="sidebarAvatar">??</div>
                    <div>
                        <div class="font-bold" id="sidebarUserName" style="font-weight: 600; font-size: 14px;">
                            Loading...</div>
                        <div class="text-xs" id="sidebarRole" style="font-size: 12px; color: var(--gray-600);">Role
                        </div>
                    </div>
                </div>
                <a href="/login/" class="logout-btn" onclick="logout()">Sign Out</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main>
            <!-- Dashboard Home / Stats -->
            <section id="dashboard" class="view-section active">
                <header>
                    <div class="page-title">
                        <h1 id="welcomeTitle">Welcome back,</h1>
                        <p id="dashboardSubtitle">Here's what's happening today.</p>
                    </div>
                    <div>
                        <button class="btn btn-outline" onclick="toggleNotifications()">
                            üîî <span id="notifCount" class="badge badge-pending hidden">0</span>
                        </button>
                    </div>
                </header>

                <div class="stats-grid" id="statsGrid">
                    <!-- Stats cards injected here -->
                </div>

                <div class="card">
                    <div class="flex-between">
                        <h3 id="recentActivityTitle">Recent Activity</h3>
                    </div>
                    <div id="recentActivityList" style="margin-top: 20px;">
                        <p class="loading-pulse">Retrieving your activity...</p>
                    </div>
                </div>
            </section>

            <!-- Registration Section (Receptionist) -->
            <section id="registration" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>Register New Patient</h1>
                        <p>Enroll a new patient. Accounts are automatically activated upon creation.</p>
                    </div>
                </header>
                <div class="card">
                    <form id="regForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>First Name</label>
                                <input type="text" name="first_name" required placeholder="John">
                            </div>
                            <div class="form-group">
                                <label>Last Name</label>
                                <input type="text" name="last_name" required placeholder="Doe">
                            </div>
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" name="email" required placeholder="john.doe@email.com">
                            </div>
                            <div class="form-group">
                                <label>Temporary Password</label>
                                <input type="text" name="password" required value="Password123!">
                            </div>
                            <div class="form-group full-width">
                                <button type="submit" class="btn btn-primary" id="regSubmit">Register Patient
                                    Account</button>
                            </div>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Appointment Booking (Receptionist) -->
            <section id="appointments" class="view-section">
                <div class="card" id="bookingFormCard" style="display: none; margin-bottom: 24px;">
                    <div class="flex-between" style="margin-bottom: 20px;">
                        <h3>Schedule New Appointment</h3>
                        <button class="btn btn-outline" onclick="toggleBookingForm()">Cancel</button>
                    </div>
                    <form id="appointmentForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select Patient</label>
                                <select name="patient" id="bookingPatientList" required>
                                    <option value="">Loading patients...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Select Department</label>
                                <select id="bookingDeptList" onchange="loadDoctorsByDept(this.value)">
                                    <option value="">-- Choose Department --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Select Doctor</label>
                                <select name="doctor" id="bookingDoctorList" required>
                                    <option value="">-- Choose Dept First --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Appointment Date</label>
                                <input type="date" name="appointment_date" required>
                            </div>
                            <div class="form-group">
                                <label>Preferred Time</label>
                                <input type="time" name="appointment_time" required>
                            </div>
                            <div class="form-group">
                                <label>Consultation Type</label>
                                <select name="appointment_type" required>
                                    <option value="GENERAL">General Consultation</option>
                                    <option value="FOLLOW_UP">Follow-up Visit</option>
                                    <option value="EMERGENCY">Emergency</option>
                                    <option value="PROCEDURE">Medical Procedure</option>
                                    <option value="VACCINATION">Vaccination</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label>Reason for Visit</label>
                                <textarea name="reason" rows="2"
                                    placeholder="Briefly describe the symptoms..."></textarea>
                            </div>
                            <div class="form-group full-width">
                                <button type="submit" class="btn btn-primary" id="bookSubmit">Confirm Booking</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <div class="flex-between" style="margin-bottom: 20px;">
                        <h3>Patient Appointments</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" id="newAppointmentBtn" onclick="toggleBookingForm()"
                                style="display: none; padding: 10px 20px;">+ Book Appointment</button>
                            <input type="date" id="scheduleDate" style="width: auto;">
                        </div>
                    </div>
                    <div id="appointmentTableContainer">
                        <p class="loading-pulse">Loading appointments...</p>
                    </div>
                </div>
            </section>

            <!-- Calendar View (Doctor) -->
            <section id="calendar" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>Doctor's Calendar</h1>
                        <p>Monthly view of your scheduled appointments.</p>
                    </div>
                    <div class="calendar-nav flex-between" style="gap: 16px;">
                        <button class="btn btn-outline" onclick="changeMonth(-1)">‚Üê Prev</button>
                        <h2 id="currentMonthYear" style="min-width: 200px; text-align: center;">Month Year</h2>
                        <button class="btn btn-outline" onclick="changeMonth(1)">Next ‚Üí</button>
                    </div>
                </header>
                <div class="card">
                    <div class="calendar-wrapper">
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Patient Records Search (All Staff) -->
            <section id="patients" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>Patient Directory</h1>
                        <p>Search and manage patient medical records.</p>
                    </div>
                </header>
                <div class="card">
                    <div style="margin-bottom: 24px;">
                        <input type="text" id="patientSearchInput" placeholder="Search patients by name or email..."
                            style="font-size: 16px; padding: 16px;">
                    </div>
                    <div id="patientListContainer">
                        <p class="loading-pulse">Searching patients...</p>
                    </div>
                </div>
            </section>

            <!-- Patient Detailed Records (Staff View) -->
            <section id="patient-records" class="view-section">
                <header>
                    <div class="page-title">
                        <h1 id="recordPatientName">Medical Records</h1>
                        <p>Detailed blockchain-verified record history for this patient.</p>
                    </div>
                    <div>
                        <button class="btn btn-outline" onclick="showTab('patients')">‚Üê Back to Directory</button>
                    </div>
                </header>
                <div id="patientRecordsList">
                    <p class="loading-pulse">Retrieving records...</p>
                </div>
            </section>

            <!-- User Management (Admin) -->
            <section id="accounts" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>User Accounts Management</h1>
                        <p>Detailed overview of all system users and their roles.</p>
                    </div>
                </header>
                <div class="card">
                    <div style="margin-bottom: 24px;">
                        <input type="text" id="userSearchInput" placeholder="Search accounts by name, email or role..."
                            style="font-size: 16px; padding: 16px;">
                    </div>
                    <div id="userListContainer">
                        <p class="loading-pulse">Retrieving system users...</p>
                    </div>
                </div>
            </section>

            <!-- Medical Record Upload (Nurse) -->
            <section id="upload" class="view-section">
                <header>
                    <div class="page-title">
                        <h1>Upload Medical Record</h1>
                        <p>Securely register medical data on the blockchain.</p>
                    </div>
                </header>
                <div class="card">
                    <form id="recordForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select Patient</label>
                                <select name="patient_email" id="uploadPatientList" required>
                                    <option value="">Loading patients...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Record Type</label>
                                <select name="record_type" required>
                                    <option value="LAB_RESULT">Laboratory Result</option>
                                    <option value="XRAY">X-Ray Report</option>
                                    <option value="CT_SCAN">CT Scan</option>
                                    <option value="MRI">MRI Scan</option>
                                    <option value="PRESCRIPTION">Prescription</option>
                                    <option value="CONSULTATION">Consultation Notes</option>
                                    <option value="DIAGNOSIS">Diagnosis Report</option>
                                    <option value="OTHER">Other</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label>Title</label>
                                <input type="text" name="title" required placeholder="Annual Check-up Results">
                            </div>
                            <div class="form-group full-width">
                                <label>Description</label>
                                <textarea name="description" rows="3"
                                    placeholder="Brief summary of the record..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Date of Service</label>
                                <input type="date" name="date_of_service" required>
                            </div>
                            <div class="form-group">
                                <label>File Attachment (PDF, Image)</label>
                                <input type="file" name="document_file" required>
                            </div>
                            <div class="form-group full-width">
                                <button type="submit" class="btn btn-primary" id="uploadSubmit">Blockchain Upload &
                                    Register</button>
                            </div>
                        </div>
                    </form>
                </div>
            </section>
        </main>

        <!-- Notifications Panel -->
        <aside class="notifications-panel" id="notificationsPanel">
            <div class="flex-between" style="margin-bottom: 24px;">
                <h3>Notifications</h3>
                <button class="btn btn-outline" onclick="toggleNotifications()">√ó</button>
            </div>
            <div id="notificationList" style="overflow-y: auto; flex: 1;">
                <p class="loading-pulse">Loading updates...</p>
            </div>
        </aside>
    </div>

    <script>
        const API_BASE = '/api';
        let currentUser = null;
        let authToken = sessionStorage.getItem('access_token');

        // Navigation Data based on Roles
        const navConfig = {
            'ADMIN': [
                { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                { id: 'accounts', label: 'Manage Accounts', icon: 'üîê' },
                { id: 'patients', label: 'Patients', icon: 'üë•' }
            ],
            'RECEPTIONIST': [
                { id: 'dashboard', label: 'Overview', icon: 'üè†' },
                { id: 'registration', label: 'Register Patient', icon: 'üìù' },
                { id: 'appointments', label: 'Appointments', icon: 'üìÖ' },
                { id: 'patients', label: 'Patient Directory', icon: 'üîç' }
            ],
            'NURSE': [
                { id: 'dashboard', label: 'Overview', icon: 'üè†' },
                { id: 'appointments', label: 'Doctor Schedule', icon: 'üìÖ' },
                { id: 'upload', label: 'Upload Record', icon: 'üì§' },
                { id: 'patients', label: 'Patient List', icon: 'üë•' }
            ],
            'DOCTOR': [
                { id: 'dashboard', label: 'My Schedule', icon: 'üìÖ' },
                { id: 'calendar', label: 'Calendar View', icon: 'üóìÔ∏è' },
                { id: 'appointments', label: 'Appointments List', icon: 'üë®‚Äç‚öïÔ∏è' },
                { id: 'patients', label: 'Patient Search', icon: 'üîç' }
            ]
        };

        // Initialize App
        async function init() {
            if (!authToken) {
                window.location.href = '/login/';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/profile/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) throw new Error('Auth failed');

                currentUser = await response.json();
                renderSidebar();
                loadStats();
                loadRecentActivity();
                startNotificationPoller();

                if (currentUser.role === 'NURSE' || currentUser.role === 'RECEPTIONIST') {
                    loadPatientsForDropdown();
                }

                if (currentUser.role === 'ADMIN') {
                    const userSearch = document.getElementById('userSearchInput');
                    if (userSearch) {
                        userSearch.addEventListener('input', (e) => loadUsersTable(e.target.value));
                    }
                }

                if (currentUser.role === 'RECEPTIONIST') {
                    loadDepartmentsForBooking();
                    loadPatientsForBooking();
                    document.getElementById('newAppointmentBtn').style.display = 'block';
                }

                // Add patient search listener
                const searchInput = document.getElementById('patientSearchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        loadPatientsTable(e.target.value);
                    });
                }

            } catch (err) {
                console.error(err);
                sessionStorage.clear();
                window.location.href = '/login/';
            }
        }

        function renderSidebar() {
            const container = document.getElementById('navItems');
            const items = navConfig[currentUser.role] || [];

            container.innerHTML = items.map((item, index) => `
                <div class="nav-item ${index === 0 ? 'active' : ''}" onclick="showTab('${item.id}')" id="nav-${item.id}">
                    <span>${item.icon}</span>
                    <span>${item.label}</span>
                </div>
            `).join('');

            document.getElementById('sidebarUserName').textContent = currentUser.full_name || currentUser.email;
            document.getElementById('sidebarRole').textContent = currentUser.role.replace('_', ' ');
            document.getElementById('sidebarAvatar').textContent = (currentUser.first_name?.[0] || 'U').toUpperCase() + (currentUser.last_name?.[0] || '').toUpperCase();
            document.getElementById('welcomeTitle').textContent = `Welcome back, ${currentUser.first_name || 'Staff'}`;
        }

        function showTab(tabId) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));

            const section = document.getElementById(tabId);
            if (section) section.classList.add('active');

            const navItem = document.getElementById(`nav-${tabId}`);
            if (navItem) navItem.classList.add('active');

            // View-specific loaders
            if (tabId === 'appointments') loadAppointments();
            if (tabId === 'calendar') loadCalendar();
            if (tabId === 'patients') loadPatientsTable();
            if (tabId === 'accounts') loadUsersTable();
        }

        let calendarDate = new Date();

        function changeMonth(delta) {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            loadCalendar();
        }

        async function loadCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthLabel = document.getElementById('currentMonthYear');

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthLabel.textContent = `${monthNames[calendarDate.getMonth()]} ${calendarDate.getFullYear()}`;

            // Fetch appointments
            let appointments = [];
            try {
                const response = await fetch(`${API_BASE}/auth/appointments/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                appointments = await response.json();
            } catch (err) { console.error(err); }

            // Build Grid
            let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => `<div class="calendar-day-header">${d}</div>`).join('');

            const firstDay = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), 1).getDay();
            const daysInMonth = new Date(calendarDate.getFullYear(), calendarDate.getMonth() + 1, 0).getDate();
            const daysInPrevMonth = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), 0).getDate();

            // Prev month padding
            for (let i = firstDay - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month"><span class="day-number">${daysInPrevMonth - i}</span></div>`;
            }

            // Current month days
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${calendarDate.getFullYear()}-${String(calendarDate.getMonth() + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const todaysEvents = appointments.filter(a => a.appointment_date === dateStr);

                const isToday = new Date().toDateString() === new Date(calendarDate.getFullYear(), calendarDate.getMonth(), d).toDateString();

                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''}">
                        <span class="day-number">${d}</span>
                        <div class="event-list">
                            ${todaysEvents.map(e => `
                                <div class="calendar-event ${e.status}" title="${e.patient_name} - ${e.appointment_time}">
                                    ${e.appointment_time} ${e.patient_name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Next month padding
            const totalCells = html.split('calendar-day').length - 1 + (firstDay);
            const nextPadding = 42 - (firstDay + daysInMonth);
            for (let i = 1; i <= nextPadding; i++) {
                html += `<div class="calendar-day other-month"><span class="day-number">${i}</span></div>`;
            }

            grid.innerHTML = html;
        }

        async function loadStats() {
            const grid = document.getElementById('statsGrid');
            try {
                const response = await fetch(`${API_BASE}/blockchain/admin/system-stats/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const stats = await response.json();

                let html = '';
                if (currentUser.role === 'RECEPTIONIST' || currentUser.role === 'ADMIN') {
                    html += `
                        <div class="stat-card"><div class="label">Total Patients</div><div class="value">${stats.patients.total}</div></div>
                        <div class="stat-card"><div class="label">Confirmed Records</div><div class="value">${stats.medical_records.confirmed}</div></div>
                        <div class="stat-card"><div class="label">Hospital Staff</div><div class="value">${stats.staff.receptionists + stats.staff.nurses + stats.staff.doctors}</div></div>
                    `;
                } else if (currentUser.role === 'DOCTOR') {
                    const personal = stats.personal || { today_appointments: 0, pending_checkins: 0 };
                    html += `
                        <div class="stat-card"><div class="label">Today's Appointments</div><div class="value">${personal.today_appointments}</div></div>
                        <div class="stat-card"><div class="label">Patients Waiting</div><div class="value">${personal.pending_checkins}</div></div>
                        <div class="stat-card"><div class="label">System Records</div><div class="value">${stats.medical_records.total}</div></div>
                    `;
                } else if (currentUser.role === 'NURSE') {
                    html += `
                        <div class="stat-card"><div class="label">My Uploads</div><div class="value">${stats.medical_records.total}</div></div>
                        <div class="stat-card"><div class="label">Total Patients</div><div class="value">${stats.patients.total}</div></div>
                        <div class="stat-card"><div class="label">Recent Records</div><div class="value">${stats.medical_records.confirmed}</div></div>
                    `;
                }
                grid.innerHTML = html;
            } catch (err) {
                grid.innerHTML = '<p>Overview metrics loading...</p>';
            }
        }

        async function loadRecentActivity() {
            const list = document.getElementById('recentActivityList');
            const title = document.getElementById('recentActivityTitle');

            if (currentUser.role === 'DOCTOR') {
                title.textContent = "Today's Schedule";
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const response = await fetch(`${API_BASE}/auth/appointments/`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const allApp = await response.json();
                    const todayApp = allApp.filter(a => a.appointment_date === today);

                    if (todayApp.length === 0) {
                        list.innerHTML = '<p class="loading-pulse">You have no appointments scheduled for today.</p>';
                        return;
                    }

                    list.innerHTML = `<table>
                        <thead><tr><th>Time</th><th>Patient</th><th>Type</th><th>Status</th><th>Action</th></tr></thead>
                        <tbody>
                            ${todayApp.map(app => `
                                <tr>
                                    <td>${app.appointment_time}</td>
                                    <td style="font-weight: 500;">${app.patient_name}</td>
                                    <td>${app.appointment_type.replace(/_/g, ' ')}</td>
                                    <td><span class="badge ${app.status === 'SCHEDULED' ? 'badge-pending' : 'badge-active'}">${app.status}</span></td>
                                    <td>
                                        ${app.status === 'CHECKED_IN' ? `<button onclick="completeAppointment(${app.id})" class="btn btn-primary" style="padding: 4px 12px; font-size: 11px;">Complete</button>` : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;
                } catch (err) {
                    list.innerHTML = '<p>Could not load today\'s schedule</p>';
                }
                return;
            }

            // Default for other roles
            try {
                const response = await fetch(`${API_BASE}/blockchain/admin/audit-logs/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const logs = await response.json();

                if (logs.length === 0) {
                    list.innerHTML = '<p class="loading-pulse">No recent activity detected.</p>';
                    return;
                }

                list.innerHTML = `<table>
                    <thead><tr><th>Action</th><th>Resource</th><th>Date</th></tr></thead>
                    <tbody>
                        ${logs.slice(0, 5).map(log => `
                            <tr>
                                <td><span class="badge badge-active">${log.action.replace(/_/g, ' ')}</span></td>
                                <td>${log.resource_type}</td>
                                <td>${new Date(log.created_at).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            } catch (err) {
                list.innerHTML = '<p>Recent activity log unavailable</p>';
            }
        }

        // Feature: Registration
        document.getElementById('regForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('regSubmit');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            const formData = new FormData(e.target);
            const payload = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${API_BASE}/blockchain/staff/register-patient/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert('Patient registered and activated successfully!');
                    e.target.reset();
                    showTab('dashboard');
                    loadStats();
                } else {
                    const error = await response.json();
                    alert('Error: ' + JSON.stringify(error));
                }
            } catch (err) {
                alert('Connection error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Register Patient Account';
            }
        });

        // Feature: Record Upload
        const recordForm = document.getElementById('recordForm');
        if (recordForm) {
            recordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('uploadSubmit');
                btn.disabled = true;
                btn.textContent = 'Uploading to Blockchain...';

                const formData = new FormData(e.target);
                // No need to manually convert to JSON because we are uploading a file

                try {
                    const response = await fetch(`${API_BASE}/blockchain/staff/upload-record/`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: formData
                    });

                    if (response.ok) {
                        alert('Medical record successfully registered on blockchain!');
                        e.target.reset();
                        showTab('dashboard');
                        loadStats();
                    } else {
                        const error = await response.json();
                        alert('Upload failed: ' + (error.error || JSON.stringify(error)));
                    }
                } catch (err) {
                    alert('Connection error during blockchain upload');
                    console.error(err);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Blockchain Upload & Register';
                }
            });
        }

        // Feature: Appointments
        async function loadAppointments() {
            const container = document.getElementById('appointmentTableContainer');
            try {
                const response = await fetch(`${API_BASE}/auth/appointments/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--gray-600); padding: 40px;">No appointments scheduled.</p>';
                    return;
                }

                container.innerHTML = `<table>
                    <thead><tr><th>Time</th><th>Patient</th><th>Doctor</th><th>Type</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody>
                        ${data.map(app => {
                    let action = '-';
                    if (app.status === 'SCHEDULED' && currentUser.role === 'RECEPTIONIST') {
                        action = `<button onclick="checkInPatient(${app.id})" class="btn btn-outline" style="padding: 4px 12px; font-size: 11px;">Check In</button>`;
                    } else if (app.status === 'CHECKED_IN' && currentUser.role === 'DOCTOR') {
                        action = `<button onclick="completeAppointment(${app.id})" class="btn btn-primary" style="padding: 4px 12px; font-size: 11px;">Complete</button>`;
                    }

                    const badgeClass = app.status === 'SCHEDULED' ? 'badge-pending' :
                        (app.status === 'COMPLETED' ? 'badge-active' : 'badge-active');

                    return `
                                <tr>
                                    <td>${app.appointment_time}</td>
                                    <td style="font-weight: 500;">${app.patient_name}</td>
                                    <td>Dr. ${app.doctor_name}</td>
                                    <td>${app.appointment_type.replace(/_/g, ' ')}</td>
                                    <td><span class="badge ${badgeClass}">${app.status}</span></td>
                                    <td>${action}</td>
                                </tr>
                            `;
                }).join('')}
                    </tbody>
                </table>`;
            } catch (err) {
                container.innerHTML = '<p>Error loading appointments</p>';
            }
        }

        async function completeAppointment(id) {
            if (!confirm('Mark appointment as Completed?')) return;
            try {
                const response = await fetch(`${API_BASE}/auth/appointments/${id}/complete/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    alert('Appointment completed successfully!');
                    loadAppointments();
                }
            } catch (err) {
                alert('Action failed');
            }
        }

        // Feature: Patient Table
        async function loadUsersTable(search = '') {
            const container = document.getElementById('userListContainer');
            try {
                const response = await fetch(`${API_BASE}/auth/users/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                let users = await response.json();

                if (search) {
                    search = search.toLowerCase();
                    users = users.filter(u =>
                        (u.full_name && u.full_name.toLowerCase().includes(search)) ||
                        u.email.toLowerCase().includes(search) ||
                        u.role.toLowerCase().includes(search)
                    );
                }

                if (users.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--gray-600); padding: 40px;">No users found matching your search.</p>';
                    return;
                }

                container.innerHTML = `<table>
                    <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody>
                        ${users.map(u => `
                            <tr>
                                <td style="font-weight: 500;">${u.full_name || 'N/A'}</td>
                                <td>${u.email}</td>
                                <td>
                                    <select onchange="updateUserRole(${u.id}, this.value)" style="padding: 4px; font-size: 12px; border-radius: 4px; border: 1px solid var(--gray-200);">
                                        <option value="ADMIN" ${u.role === 'ADMIN' ? 'selected' : ''}>ADMIN</option>
                                        <option value="DOCTOR" ${u.role === 'DOCTOR' ? 'selected' : ''}>DOCTOR</option>
                                        <option value="NURSE" ${u.role === 'NURSE' ? 'selected' : ''}>NURSE</option>
                                        <option value="RECEPTIONIST" ${u.role === 'RECEPTIONIST' ? 'selected' : ''}>RECEPTIONIST</option>
                                        <option value="PATIENT" ${u.role === 'PATIENT' ? 'selected' : ''}>PATIENT</option>
                                    </select>
                                </td>
                                <td><span class="badge badge-active">${u.is_active ? 'ACTIVE' : 'INACTIVE'}</span></td>
                                <td>
                                    <button class="btn" style="color: var(--danger); padding: 4px 8px; font-size: 11px;" onclick="deleteUser(${u.id})">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            } catch (err) {
                container.innerHTML = '<p>Error loading system users</p>';
            }
        }

        async function updateUserRole(userId, newRole) {
            if (!confirm(`Change this user's role to ${newRole}?`)) {
                loadUsersTable();
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/auth/users/${userId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ role: newRole })
                });
                if (response.ok) {
                    alert('User role updated successfully.');
                    loadUsersTable();
                } else {
                    alert('Failed to update role.');
                }
            } catch (err) { alert('Connection error'); }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you SURE you want to delete this account? This action cannot be undone.')) return;
            try {
                const response = await fetch(`${API_BASE}/auth/users/${userId}/`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    alert('User account deleted.');
                    loadUsersTable();
                } else {
                    alert('Failed to delete user.');
                }
            } catch (err) { alert('Connection error'); }
        }

        async function loadPatientsTable(search = '') {
            const container = document.getElementById('patientListContainer');
            try {
                const response = await fetch(`${API_BASE}/blockchain/staff/patients/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                let patients = await response.json();

                if (search) {
                    patients = patients.filter(p =>
                        (p.full_name && p.full_name.toLowerCase().includes(search.toLowerCase())) ||
                        p.email.toLowerCase().includes(search.toLowerCase())
                    );
                }

                if (patients.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--gray-600); padding: 40px;">No patients found.</p>';
                    return;
                }

                container.innerHTML = `<table>
                    <thead><tr><th>Name</th><th>Email</th><th>Age</th><th>Gender</th><th>Actions</th></tr></thead>
                    <tbody>
                        ${patients.map(p => `
                            <tr>
                                <td style="font-weight: 500;">${p.full_name || 'N/A'}</td>
                                <td>${p.email}</td>
                                <td>${p.age || 'N/A'}</td>
                                <td>${p.gender || 'N/A'}</td>
                                <td>
                                    <button class="btn btn-outline" style="padding: 4px 12px; font-size: 12px;" onclick="viewPatientRecords(${p.id}, '${p.full_name || p.email}')">View Records</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            } catch (err) {
                container.innerHTML = '<p>Error search patients</p>';
            }
        }

        async function viewPatientRecords(patientId, patientName) {
            document.getElementById('recordPatientName').textContent = `Records: ${patientName}`;
            showTab('patient-records');
            const container = document.getElementById('patientRecordsList');
            container.innerHTML = '<p class="loading-pulse">Retrieving blockchain records...</p>';

            try {
                const response = await fetch(`${API_BASE}/blockchain/staff/patients/${patientId}/records/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const records = await response.json();

                if (records.length === 0) {
                    container.innerHTML = '<div class="card" style="text-align: center; color: var(--gray-600); padding: 40px;">No medical records found for this patient.</div>';
                    return;
                }

                container.innerHTML = records.map(record => `
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="flex-between" style="margin-bottom: 12px;">
                            <h3 style="margin: 0;">${record.title}</h3>
                            <span class="badge badge-active">${record.record_type.replace(/_/g, ' ')}</span>
                        </div>
                        <div style="font-size: 14px; color: var(--gray-600); line-height: 1.6;">
                            <p><strong>üìÖ Date of Service:</strong> ${new Date(record.date_of_service).toLocaleDateString()}</p>
                            ${record.description ? `<p><strong>üìù Notes:</strong> ${record.description}</p>` : ''}
                            <p><strong>üë®‚Äç‚öïÔ∏è Uploaded by:</strong> ${record.uploaded_by_name}</p>
                            <p><strong>üîó Blockchain Hash:</strong> <code style="background: #f1f5f9; padding: 2px 4px; border-radius: 4px;">${record.short_tx_hash}</code></p>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="btn btn-primary" onclick="window.open('${record.file_url}', '_blank')">View File Attachment</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = `<div class="card" style="color: var(--danger);">Failed to load patient records: ${err.message}</div>`;
            }
        }

        async function checkInPatient(id) {
            if (!confirm('Mark patient as Arrived?')) return;
            try {
                const response = await fetch(`${API_BASE}/auth/appointments/${id}/check-in/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    alert('Check-in successful! Doctor has been notified.');
                    loadAppointments();
                }
            } catch (err) {
                alert('Action failed');
            }
        }

        // Feature: Notifications
        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                loadNotifications();
            }
        }

        async function loadNotifications() {
            const list = document.getElementById('notificationList');
            try {
                const response = await fetch(`${API_BASE}/auth/notifications/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                const unreadCount = data.filter(n => !n.is_read).length;
                const notifBadge = document.getElementById('notifCount');
                notifBadge.textContent = unreadCount;
                if (unreadCount > 0) {
                    notifBadge.classList.remove('hidden');
                } else {
                    notifBadge.classList.add('hidden');
                }

                if (data.length === 0) {
                    list.innerHTML = '<div style="text-align: center; color: var(--gray-600); padding: 40px;"><p>No new notifications</p></div>';
                    return;
                }

                list.innerHTML = data.map(n => `
                    <div class="notification-item ${n.is_read ? '' : 'unread'}">
                        <div style="font-weight: 600; margin-bottom: 4px;">${n.title}</div>
                        <div>${n.message}</div>
                        <div class="time">${new Date(n.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                        ${!n.is_read ? `<button onclick="markRead(${n.id})" style="border: none; background: none; color: var(--primary); font-size: 11px; font-weight: 700; cursor: pointer; margin-top: 8px;">Mark Read</button>` : ''}
                    </div>
                `).join('');
            } catch (err) {
                list.innerHTML = '<p>Error loading updates</p>';
            }
        }

        async function markRead(id) {
            await fetch(`${API_BASE}/auth/notifications/${id}/read/`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            loadNotifications();
        }

        function startNotificationPoller() {
            setInterval(loadNotifications, 30000); // Polling every 30s
            loadNotifications();
        }

        async function loadPatientsForDropdown() {
            const select = document.getElementById('uploadPatientList');
            try {
                const response = await fetch(`${API_BASE}/blockchain/staff/patients/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const patients = await response.json();
                select.innerHTML = '<option value="">-- Select Patient --</option>' +
                    patients.map(p => `<option value="${p.email}">${p.full_name || p.email} (${p.email})</option>`).join('');
            } catch (err) {
                select.innerHTML = '<option value="">Error loading list</option>';
            }
        }

        // Feature: Appointment Booking
        function toggleBookingForm() {
            const form = document.getElementById('bookingFormCard');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function loadDepartmentsForBooking() {
            const select = document.getElementById('bookingDeptList');
            try {
                const response = await fetch(`${API_BASE}/auth/departments/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const depts = await response.json();
                select.innerHTML = '<option value="">-- Choose Department --</option>' +
                    depts.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            } catch (err) { console.error(err); }
        }

        async function loadPatientsForBooking() {
            const select = document.getElementById('bookingPatientList');
            try {
                const response = await fetch(`${API_BASE}/blockchain/staff/patients/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const patients = await response.json();
                select.innerHTML = '<option value="">-- Select Patient --</option>' +
                    patients.map(p => `<option value="${p.id}">${p.full_name || p.email} (${p.email})</option>`).join('');
            } catch (err) { console.error(err); }
        }

        async function loadDoctorsByDept(deptId) {
            const select = document.getElementById('bookingDoctorList');
            if (!deptId) {
                select.innerHTML = '<option value="">-- Choose Dept First --</option>';
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/auth/departments/${deptId}/doctors/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const doctors = await response.json();
                select.innerHTML = '<option value="">-- Select Doctor --</option>' +
                    doctors.map(d => `<option value="${d.id}">Dr. ${d.full_name}</option>`).join('');
            } catch (err) { console.error(err); }
        }

        document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('bookSubmit');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            const formData = new FormData(e.target);
            const payload = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${API_BASE}/auth/appointments/create/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert('Appointment scheduled successfully!');
                    e.target.reset();
                    toggleBookingForm();
                    loadAppointments();
                } else {
                    const errorText = await response.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        alert('Booking failed: ' + JSON.stringify(errorJson));
                    } catch (e) {
                        alert('Server error: ' + response.status);
                    }
                }
            } catch (err) {
                alert('Connection error: ' + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Confirm Booking';
            }
        });

        function logout() {
            sessionStorage.clear();
        }

        init();
    </script>
</body>

</html>